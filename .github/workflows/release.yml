name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on tags like v0.1.0, v1.0.0, v2.1.3-beta

permissions:
  contents: write  # Required for creating releases

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for version info

    - name: Extract version from tag
      id: version
      shell: pwsh
      run: |
        $tag = "${{ github.ref_name }}"
        $version = $tag -replace '^v', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version from tag: $version"

    - name: Validate version matches Directory.Build.props
      shell: pwsh
      run: |
        $tagVersion = "${{ steps.version.outputs.VERSION }}"
        
        # Read version from Directory.Build.props
        [xml]$props = Get-Content "Directory.Build.props"
        $propsVersion = $props.Project.PropertyGroup.Version
        
        Write-Host "Tag version: $tagVersion"
        Write-Host "Directory.Build.props version: $propsVersion"
        
        if ($tagVersion -ne $propsVersion) {
          Write-Error "âŒ Version mismatch!"
          Write-Error "Git tag: v$tagVersion"
          Write-Error "Directory.Build.props: $propsVersion"
          Write-Error ""
          Write-Error "Please update Directory.Build.props to version $tagVersion and push before tagging."
          exit 1
        }
        
        Write-Host "âœ… Version validation passed: $tagVersion"

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Install WiX Toolset
      shell: pwsh
      run: |
        dotnet tool install --global wix --version 4.0.5
        wix --version

    - name: Restore dependencies
      run: dotnet restore

    - name: Build App
      # Version is inherited from Directory.Build.props
      # Use /maxcpucount:1 to prevent WPF XAML parallel compilation race conditions
      # This is a known issue with WPF projects: https://github.com/dotnet/wpf/issues/4814
      run: dotnet build src\MarkRead.App.csproj --configuration Release --no-restore /maxcpucount:1

    - name: Build MSI installer
      # Version is inherited from Directory.Build.props
      shell: pwsh
      run: |
        dotnet build installer\MarkRead.Installer.wixproj --configuration Release --no-restore /maxcpucount:1

    - name: Locate unsigned MSI file
      id: locate_msi
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $msiPath = Get-ChildItem -Path "installer\bin\Release" -Filter "MarkRead-*.msi" -Recurse | Select-Object -First 1
        
        if ($msiPath) {
          $fullPath = $msiPath.FullName
          echo "UNSIGNED_MSI_PATH=$fullPath" >> $env:GITHUB_OUTPUT
          echo "MSI_NAME=$($msiPath.Name)" >> $env:GITHUB_OUTPUT
          echo "Found unsigned MSI: $fullPath"
        } else {
          echo "ERROR: MSI file not found!"
          exit 1
        }
    
    - name: Upload unsigned MSI as artifact (for SignPath)
      uses: actions/upload-artifact@v4
      with:
        name: unsigned-msi
        path: ${{ steps.locate_msi.outputs.UNSIGNED_MSI_PATH }}
        retention-days: 5

    - name: Submit to SignPath.io for signing
      if: vars.SIGNPATH_ENABLED == 'true'
      uses: signpath/github-action-submit-signing-request@v1
      with:
        api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
        organization-id: ${{ vars.SIGNPATH_ORGANIZATION_ID }}
        project-slug: ${{ vars.SIGNPATH_PROJECT_SLUG }}
        signing-policy-slug: ${{ vars.SIGNPATH_SIGNING_POLICY }}
        github-artifact-id: 'unsigned-msi'
        wait-for-completion: true
        output-artifact-directory: 'signed'

    - name: Determine final MSI path
      id: final_msi
      shell: pwsh
      run: |
        $signPathEnabled = "${{ vars.SIGNPATH_ENABLED }}" -eq "true"
        
        if ($signPathEnabled) {
          # Use signed MSI if SignPath is enabled
          $signedMsi = Get-ChildItem -Path "signed" -Filter "MarkRead-*.msi" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          
          if ($signedMsi) {
            $finalPath = $signedMsi.FullName
            echo "MSI_PATH=$finalPath" >> $env:GITHUB_OUTPUT
            echo "MSI_NAME=$($signedMsi.Name)" >> $env:GITHUB_OUTPUT
            echo "âœ… Using signed MSI: $finalPath"
            echo "SIGNED=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Warning "âš ï¸ SignPath signing was enabled but no signed MSI found. Using unsigned MSI."
            $unsignedPath = "${{ steps.locate_msi.outputs.UNSIGNED_MSI_PATH }}"
            echo "MSI_PATH=$unsignedPath" >> $env:GITHUB_OUTPUT
            echo "MSI_NAME=${{ steps.locate_msi.outputs.MSI_NAME }}" >> $env:GITHUB_OUTPUT
            echo "SIGNED=false" >> $env:GITHUB_OUTPUT
          }
        } else {
          # Use unsigned MSI
          $unsignedPath = "${{ steps.locate_msi.outputs.UNSIGNED_MSI_PATH }}"
          echo "MSI_PATH=$unsignedPath" >> $env:GITHUB_OUTPUT
          echo "MSI_NAME=${{ steps.locate_msi.outputs.MSI_NAME }}" >> $env:GITHUB_OUTPUT
          echo "âš ï¸ SignPath.io signing disabled - using unsigned MSI"
          echo "SIGNED=false" >> $env:GITHUB_OUTPUT
        }

    - name: Calculate SHA256
      id: hash
      shell: pwsh
      run: |
        $msiPath = "${{ steps.final_msi.outputs.MSI_PATH }}"
        $hash = (Get-FileHash -Path $msiPath -Algorithm SHA256).Hash
        echo "SHA256=$hash" >> $env:GITHUB_OUTPUT
        echo "SHA256: $hash"
        
        # Save to file for release notes
        "SHA256: $hash" | Out-File -FilePath "SHA256SUMS.txt"

    - name: Generate release notes
      id: notes
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $msiName = "${{ steps.final_msi.outputs.MSI_NAME }}"
        $hash = "${{ steps.hash.outputs.SHA256 }}"
        $isSigned = "${{ steps.final_msi.outputs.SIGNED }}" -eq "true"
        
        $content = "## MarkRead v$version`n`n"
        $content += "### Installation`n`n"
        $content += "Download the MSI installer below and run it.`n`n"
        
        if ($isSigned) {
          $content += "ðŸ”’ **This installer is digitally signed** via [SignPath.io](https://signpath.io) for your security.`n`n"
        } else {
          $content += "âš ï¸ **Note:** This installer is currently unsigned. Windows may show a SmartScreen warning.`n`n"
        }
        
        $content += "The installer will:`n"
        $content += "- Install MarkRead to Program Files`n"
        $content += "- Create Start Menu shortcut`n"
        $content += "- Create Desktop shortcut`n"
        $content += "- Associate .md and .markdown files with MarkRead`n"
        $content += "- Add MarkRead to Windows Programs & Features`n`n"
        $content += "**System Requirements:**`n"
        $content += "- Windows 10 (1809+) or Windows 11`n"
        $content += "- No additional runtime required (self-contained)`n`n"
        $content += "### What's New`n`n"
        $content += "See [CHANGELOG.md](https://github.com/schalkje/markread/blob/main/CHANGELOG.md) for full details.`n`n"
        $content += "### Files`n`n"
        $content += "- **$msiName** - Windows MSI Installer"
        if ($isSigned) {
          $content += " (Digitally Signed)"
        }
        $content += "`n"
        $content += "- **SHA256SUMS.txt** - Checksum for verification`n`n"
        $content += "### Verification`n`n"
        $content += "`n"
        $content += "SHA256: $hash`n"
        $content += "`n`n"
        $content += "### Uninstallation`n`n"
        $content += "To uninstall, use Windows Settings > Apps or Add or Remove Programs in Control Panel.`n`n"
        $content += "---`n`n"
        $content += "**First time installing?** Check out the [Getting Started Guide](https://github.com/schalkje/markread/blob/main/documentation/user-guide/getting-started.md)"
        
        $content | Out-File -FilePath "release-notes.md" -Encoding utf8

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ steps.final_msi.outputs.MSI_PATH }}
          SHA256SUMS.txt
        body_path: release-notes.md
        draft: false
        prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
        token: ${{ secrets.GITHUB_TOKEN }}
