<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
    <title>{{TITLE}}</title>
    
    <!-- Inline theme styles to prevent white flash -->
    {{THEME_STYLES}}
    
    <!-- Base Styles -->
    <link rel="stylesheet" href="../assets/styles.css" />
    <link rel="stylesheet" href="../assets/theme-light.css" />
    <link rel="stylesheet" href="../assets/theme-dark.css" />
    
    <!-- Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" media="(prefers-color-scheme: light)" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" media="(prefers-color-scheme: dark)" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid Diagrams -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11.4.0/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose'
        });
    </script>
    
    <style>
        /* Prevent white flash on load */
        html {
            background: var(--background-color);
            color: var(--text-color);
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Performance optimizations */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        img, video {
            will-change: transform;
        }
        
        /* Search highlight styles */
        .search-highlight {
            background-color: #ffd70080;
            transition: background-color 0.3s ease;
        }
        
        .search-highlight-current {
            background-color: #ff6b1880;
            box-shadow: 0 0 4px #ff6b18;
        }
        
        @media (prefers-color-scheme: dark) {
            .search-highlight {
                background-color: #3d3d0080;
            }
            
            .search-highlight-current {
                background-color: #ff6b1880;
                box-shadow: 0 0 4px #ff6b18;
            }
        }
        
        /* Link hover tooltip */
        .link-tooltip {
            position: fixed;
            background: var(--background-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 12px;
            font-family: monospace;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            pointer-events: none;
            z-index: 1000;
            max-width: 400px;
            word-break: break-all;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .link-tooltip.visible {
            opacity: 1;
        }
    </style>
</head>
<body class="{{THEME_CLASS}}">
    <div id="markdown-content" class="markdown-body">
        {{CONTENT}}
    </div>
    
    <script>
        // Initialize syntax highlighting
        document.addEventListener('DOMContentLoaded', () => {
            hljs.highlightAll();
        });
        
        // C# Bridge for link clicks
        document.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link && link.href) {
                e.preventDefault();
                window.chrome.webview.postMessage({
                    type: 'linkClick',
                    href: link.href,
                    target: link.target
                });
            }
        });
        
        // Scroll position tracking
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                window.chrome.webview.postMessage({
                    type: 'scrollPosition',
                    position: window.scrollY
                });
            }, 100);
        });
        
        // Expose scroll restoration function
        window.restoreScroll = (position) => {
            window.scrollTo(0, position);
        };
        
        // Scroll to top/bottom functions
        window.scrollToTop = () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        };
        
        window.scrollToBottom = () => {
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: 'smooth'
            });
        };
        
        // Search functionality
        let searchHighlights = [];
        let currentHighlightIndex = -1;
        
        window.highlightSearchResults = (matches) => {
            // Clear previous highlights
            clearSearchHighlights();
            
            if (!matches || matches.length === 0) {
                return;
            }
            
            const content = document.getElementById('markdown-content');
            searchHighlights = [];
            
            // Create highlights for each match
            matches.forEach((match, index) => {
                const range = findTextRange(content, match.offset, match.length);
                if (range) {
                    const span = document.createElement('span');
                    span.className = 'search-highlight';
                    span.setAttribute('data-search-index', index);
                    range.surroundContents(span);
                    searchHighlights.push(span);
                }
            });
        };
        
        window.clearSearchHighlights = () => {
            searchHighlights.forEach(span => {
                const parent = span.parentNode;
                if (parent) {
                    parent.replaceChild(document.createTextNode(span.textContent), span);
                    parent.normalize();
                }
            });
            searchHighlights = [];
            currentHighlightIndex = -1;
        };
        
        window.scrollToSearchMatch = (index) => {
            if (index < 0 || index >= searchHighlights.length) {
                return;
            }
            
            // Remove current highlight from previous match
            if (currentHighlightIndex >= 0 && currentHighlightIndex < searchHighlights.length) {
                searchHighlights[currentHighlightIndex].classList.remove('search-highlight-current');
            }
            
            // Add current highlight to new match
            currentHighlightIndex = index;
            const span = searchHighlights[index];
            span.classList.add('search-highlight-current');
            
            // Smooth scroll to match with offset for better visibility
            const rect = span.getBoundingClientRect();
            const offset = window.innerHeight / 3;
            window.scrollTo({
                top: window.scrollY + rect.top - offset,
                behavior: 'smooth'
            });
        };
        
        // Helper function to find text range at specific offset
        function findTextRange(node, offset, length) {
            const walker = document.createTreeWalker(
                node,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            let currentOffset = 0;
            let textNode = walker.nextNode();
            
            while (textNode) {
                const textLength = textNode.textContent.length;
                
                if (currentOffset + textLength > offset) {
                    const startOffset = offset - currentOffset;
                    const endOffset = Math.min(startOffset + length, textLength);
                    
                    const range = document.createRange();
                    range.setStart(textNode, startOffset);
                    range.setEnd(textNode, endOffset);
                    return range;
                }
                
                currentOffset += textLength;
                textNode = walker.nextNode();
            }
            
            return null;
        }
        
        // Link hover tooltip functionality
        let tooltip = null;
        
        function showLinkTooltip(event, href) {
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.className = 'link-tooltip';
                document.body.appendChild(tooltip);
            }
            
            tooltip.textContent = href;
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY + 10 + 'px';
            
            // Force reflow to trigger transition
            tooltip.offsetHeight;
            tooltip.classList.add('visible');
        }
        
        function hideLinkTooltip() {
            if (tooltip) {
                tooltip.classList.remove('visible');
            }
        }
        
        // Add hover listeners to all links
        document.addEventListener('DOMContentLoaded', () => {
            document.addEventListener('mouseover', (e) => {
                const link = e.target.closest('a');
                if (link && link.href) {
                    showLinkTooltip(e, link.href);
                }
            });
            
            document.addEventListener('mouseout', (e) => {
                const link = e.target.closest('a');
                if (link) {
                    hideLinkTooltip();
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                const link = e.target.closest('a');
                if (link && tooltip && tooltip.classList.contains('visible')) {
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY + 10 + 'px';
                }
            });
        });
    </script>
</body>
</html>
