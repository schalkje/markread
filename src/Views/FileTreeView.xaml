<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:MarkRead.ViewModels"
             xmlns:models="clr-namespace:MarkRead.Models"
             xmlns:behaviors="clr-namespace:MarkRead.Behaviors"
             x:Class="MarkRead.Views.FileTreeView"
             x:DataType="viewmodels:FileTreeViewModel">
    
    <Grid RowDefinitions="Auto,*">
        <!-- Search Bar -->
        <Border Grid.Row="0"
                Padding="8"
                BackgroundColor="{DynamicResource SurfaceColor}"
                Stroke="{DynamicResource Gray300}"
                StrokeThickness="0,0,0,1">
            <Entry Text="{Binding SearchQuery}"
                   Placeholder="Search files..."
                   ClearButtonVisibility="WhileEditing"
                   FontSize="13"
                   BackgroundColor="{DynamicResource Gray100}"
                   SemanticProperties.Description="Search for files in the current folder"
                   SemanticProperties.Hint="Type to filter the file tree" />
        </Border>
        
        <!-- File Tree -->
        <Grid Grid.Row="1">
            <ScrollView>
                <ScrollView.Behaviors>
                    <behaviors:MomentumScrollBehavior />
                </ScrollView.Behaviors>
                <CollectionView ItemsSource="{Binding Nodes}"
                               SelectionMode="None"
                               Margin="4,0">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:FileTreeNode">
                            <!-- Node Item -->
                            <Grid Padding="0"
                                  HeightRequest="32"
                                  ColumnDefinitions="Auto,Auto,*"
                                  BackgroundColor="Transparent">
                                
                                <!-- Indentation based on level -->
                                <BoxView Grid.Column="0"
                                         WidthRequest="{Binding Level, Converter={StaticResource LevelToIndentConverter}}"
                                         HeightRequest="1"
                                         Color="Transparent" />
                                
                                <!-- Expand/Collapse Icon -->
                                <Label Grid.Column="1"
                                       Text="{Binding Type, Converter={StaticResource NodeTypeToIconConverter}}"
                                       FontSize="14"
                                       VerticalOptions="Center"
                                       Margin="2,0"
                                       TextColor="{DynamicResource Gray700}"
                                       SemanticProperties.Description="{Binding Type, Converter={StaticResource NodeTypeToAccessibilityTextConverter}}"
                                       SemanticProperties.Hint="{Binding IsExpanded, Converter={StaticResource ExpandStateToHintConverter}}">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:FileTreeViewModel}}, Path=ToggleNodeExpansionCommand}"
                                                            CommandParameter="{Binding .}" />
                                    </Label.GestureRecognizers>
                                </Label>
                                
                                <!-- File/Folder Name -->
                                <Label Grid.Column="2"
                                       Text="{Binding Name}"
                                       FontSize="13"
                                       VerticalOptions="Center"
                                       TextColor="{DynamicResource Gray900}"
                                       LineBreakMode="TailTruncation"
                                       SemanticProperties.Description="{Binding Name}"
                                       SemanticProperties.Hint="{Binding Type, Converter={StaticResource NodeTypeToActionHintConverter}}">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:FileTreeViewModel}}, Path=OpenFileCommand}"
                                                            CommandParameter="{Binding .}" />
                                    </Label.GestureRecognizers>
                                </Label>
                                
                                <!-- Hover Effect (for Desktop) -->
                                <Grid.GestureRecognizers>
                                    <PointerGestureRecognizer PointerEntered="OnNodePointerEntered"
                                                            PointerExited="OnNodePointerExited" />
                                </Grid.GestureRecognizers>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </ScrollView>
            
            <!-- Loading Indicator -->
            <ActivityIndicator IsRunning="{Binding IsLoading}"
                             IsVisible="{Binding IsLoading}"
                             VerticalOptions="Center"
                             HorizontalOptions="Center" />
        </Grid>
    </Grid>
    
</ContentView>
