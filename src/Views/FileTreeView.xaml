<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:MarkRead.ViewModels"
             xmlns:models="clr-namespace:MarkRead.Models"
             xmlns:behaviors="clr-namespace:MarkRead.Behaviors"
             x:Class="MarkRead.Views.FileTreeView"
             x:DataType="viewmodels:FileTreeViewModel">
    
    <Grid RowDefinitions="Auto,*">
        <!-- Search Bar -->
        <Border Grid.Row="0"
                Padding="8"
                BackgroundColor="{DynamicResource Gray100Color}">
            <Entry Text="{Binding SearchQuery}"
                   Placeholder="Type to search files..."
                   ClearButtonVisibility="WhileEditing"
                   FontSize="14"
                   SemanticProperties.Description="Search for files in the current folder"
                   SemanticProperties.Hint="Type to filter the file tree" />
        </Border>
        
        <!-- File Tree -->
        <ScrollView Grid.Row="1">
            <ScrollView.Behaviors>
                <behaviors:MomentumScrollBehavior />
            </ScrollView.Behaviors>
            <StackLayout Spacing="0" Padding="4">
                <CollectionView ItemsSource="{Binding Nodes}"
                               SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:FileTreeNode">
                            <StackLayout>
                                <!-- Node Item -->
                                <Grid Padding="0"
                                      HeightRequest="44"
                                      ColumnDefinitions="Auto,Auto,*">
                                    
                                    <!-- Indentation based on level -->
                                    <BoxView Grid.Column="0"
                                             WidthRequest="{Binding Level, Converter={StaticResource LevelToIndentConverter}}"
                                             HeightRequest="1"
                                             Color="Transparent" />
                                    
                                    <!-- Expand/Collapse Icon -->
                                    <Label Grid.Column="1"
                                           Text="{Binding Type, Converter={StaticResource NodeTypeToIconConverter}}"
                                           FontSize="16"
                                           VerticalOptions="Center"
                                           Margin="4,0"
                                           SemanticProperties.Description="{Binding Type, Converter={StaticResource NodeTypeToAccessibilityTextConverter}}"
                                           SemanticProperties.Hint="{Binding IsExpanded, Converter={StaticResource ExpandStateToHintConverter}}">
                                        <Label.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:FileTreeViewModel}}, Path=ToggleNodeExpansionCommand}"
                                                                CommandParameter="{Binding .}" />
                                        </Label.GestureRecognizers>
                                    </Label>
                                    
                                    <!-- File/Folder Name -->
                                    <Label Grid.Column="2"
                                           Text="{Binding Name}"
                                           FontSize="14"
                                           VerticalOptions="Center"
                                           TextColor="{DynamicResource Gray900Color}"
                                           SemanticProperties.Description="{Binding Name}"
                                           SemanticProperties.Hint="{Binding Type, Converter={StaticResource NodeTypeToActionHintConverter}}">
                                        <Label.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:FileTreeViewModel}}, Path=OpenFileCommand}"
                                                                CommandParameter="{Binding .}" />
                                        </Label.GestureRecognizers>
                                    </Label>
                                    
                                    <!-- Hover Effect (for Desktop) -->
                                    <Grid.GestureRecognizers>
                                        <PointerGestureRecognizer PointerEntered="OnNodePointerEntered"
                                                                PointerExited="OnNodePointerExited" />
                                    </Grid.GestureRecognizers>
                                </Grid>
                                
                                <!-- Children (if expanded) -->
                                <StackLayout IsVisible="{Binding IsExpanded}"
                                           Spacing="0">
                                    <CollectionView ItemsSource="{Binding Children}"
                                                   SelectionMode="None">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="models:FileTreeNode">
                                                <ContentView>
                                                    <!-- Recursive template reference handled in code-behind -->
                                                </ContentView>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </StackLayout>
                            </StackLayout>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                
                <!-- Loading Indicator -->
                <ActivityIndicator IsRunning="{Binding IsLoading}"
                                 IsVisible="{Binding IsLoading}"
                                 VerticalOptions="Center"
                                 HorizontalOptions="Center"
                                 Margin="0,20" />
            </StackLayout>
        </ScrollView>
    </Grid>
    
</ContentView>
