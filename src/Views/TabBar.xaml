<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:MarkRead.ViewModels"
             xmlns:behaviors="clr-namespace:MarkRead.Behaviors"
             x:Class="MarkRead.Views.TabBar"
             x:DataType="viewmodels:MainViewModel">
    <Grid BackgroundColor="{DynamicResource SurfaceColor}"
          HeightRequest="42"
          Padding="4,0">
        
        <!-- Tab ScrollView for overflow support -->
        <ScrollView Orientation="Horizontal"
                    HorizontalScrollBarVisibility="Never"
                    VerticalScrollBarVisibility="Never">
            <CollectionView ItemsSource="{Binding Tabs}"
                            SelectionMode="None">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Horizontal" ItemSpacing="0" />
                </CollectionView.ItemsLayout>
                
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="viewmodels:TabViewModel">
                        <Border Stroke="{DynamicResource Gray300}"
                                StrokeThickness="1,1,1,0"
                                Padding="10,6"
                                Margin="2,4,0,0"
                                MinimumWidthRequest="120"
                                MaximumWidthRequest="200"
                                BackgroundColor="{Binding IsActive, Converter={StaticResource BoolToColorConverter}, 
                                                          ConverterParameter='active'}"
                                StrokeShape="RoundRectangle 4,4,0,0">
                            
                            <!-- Add drag behavior for reordering -->
                            <Border.Behaviors>
                                <behaviors:TabDragBehavior />
                            </Border.Behaviors>
                            
                            <!-- Tab Container -->
                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="6">
                                
                                <!-- Pin Icon (if pinned) -->
                                <Image Grid.Column="0" 
                                       Source="pin.png"
                                       WidthRequest="12"
                                       HeightRequest="12"
                                       IsVisible="{Binding IsPinned}"
                                       VerticalOptions="Center" />
                                
                                <!-- Tab Title -->
                                <Label Grid.Column="1"
                                       Text="{Binding Title}"
                                       FontSize="12"
                                       FontFamily="OpenSansRegular"
                                       LineBreakMode="TailTruncation"
                                       VerticalOptions="Center"
                                       TextColor="{DynamicResource Gray900}"
                                       SemanticProperties.Description="{Binding Title}"
                                       SemanticProperties.Hint="Double tap to switch to this tab">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=SwitchToTabCommand}"
                                                              CommandParameter="{Binding Id}" />
                                    </Label.GestureRecognizers>
                                </Label>
                                
                                <!-- Close Button -->
                                <Button Grid.Column="2"
                                        Text="Ã—"
                                        FontSize="16"
                                        WidthRequest="20"
                                        HeightRequest="20"
                                        Padding="0"
                                        CornerRadius="2"
                                        BackgroundColor="Transparent"
                                        TextColor="{DynamicResource Gray600}"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=CloseTabCommand}"
                                        CommandParameter="{Binding Id}"
                                        VerticalOptions="Center"
                                        ToolTipProperties.Text="Close tab (Ctrl+W)"
                                        SemanticProperties.Hint="Close this tab. Keyboard shortcut: Control plus W">
                                    <Button.Triggers>
                                        <DataTrigger TargetType="Button" Binding="{Binding IsPinned}" Value="True">
                                            <Setter Property="IsVisible" Value="False" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>
                            </Grid>
                            
                            <!-- Visual State Manager for hover effects -->
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup Name="CommonStates">
                                    <VisualState Name="Normal" />
                                    <VisualState Name="PointerOver">
                                        <VisualState.Setters>
                                            <Setter Property="BackgroundColor" 
                                                    Value="{DynamicResource Gray200Color}" />
                                        </VisualState.Setters>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </ScrollView>
        
        <!-- New Tab Button -->
        <Button Text="+"
                FontSize="20"
                WidthRequest="32"
                HeightRequest="32"
                Padding="0"
                CornerRadius="4"
                BackgroundColor="Transparent"
                TextColor="{DynamicResource Gray700}"
                Command="{Binding NewTabCommand}"
                HorizontalOptions="End"
                VerticalOptions="Center"
                Margin="8,0,4,0"
                ToolTipProperties.Text="New tab (Ctrl+T)"
                SemanticProperties.Hint="Open a new tab. Keyboard shortcut: Control plus T" />
    </Grid>
</ContentView>
